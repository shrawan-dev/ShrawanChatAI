<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShrawanChatAI Professional Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- THEMES --- */
        :root[data-theme="dark"] {
            --bg-main: #0b0b0d; --sidebar-bg: #161719; --input-bg: #1e1f21;
            --text-main: #e3e3e3; --text-sub: #9aa0a6; --accent-color: #3b82f6;
            --msg-user-bg: #2d2e30; --border-color: #333333; --menu-hover: #202124;
            --card-bg: #161719; --modal-bg: #1c1d1f; --code-bg: #000000;
        }
        :root[data-theme="light"] {
            --bg-main: #ffffff; --sidebar-bg: #f5f5f5; --input-bg: #ffffff;
            --text-main: #1f1f1f; --text-sub: #5f6368; --accent-color: #2563eb;
            --msg-user-bg: #f3f4f6; --border-color: #e5e7eb; --menu-hover: #e8eaed;
            --card-bg: #ffffff; --modal-bg: #ffffff; --code-bg: #f8f9fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-main); color: var(--text-main); height: 100dvh; display: flex; overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* --- SHARED --- */
        .hidden { display: none !important; }
        input, textarea, select { background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-main); padding: 12px; border-radius: 8px; outline: none; width: 100%; font-size: 14px; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent-color); }
        button { cursor: pointer; font-family: 'Inter', sans-serif; }
        .primary-btn { background: var(--accent-color); color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .primary-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .icon-btn { background: transparent; border: none; color: var(--text-sub); padding: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { background: var(--menu-hover); color: var(--text-main); }

        /* --- SIDEBAR --- */
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }
        .sidebar { position: fixed; left: -300px; width: 280px; height: 100%; background: var(--sidebar-bg); transition: left 0.3s ease; z-index: 1000; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; }
        .sidebar.active { left: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .brand-title { font-size: 18px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }
        
        .btn-new-chat { background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main); padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; margin-bottom: 25px; font-weight: 500; transition: 0.2s; width: 100%; justify-content: flex-start; }
        .btn-new-chat:hover { border-color: var(--accent-color); }
        
        .history-section { flex: 1; overflow-y: auto; }
        .history-label { font-size: 11px; color: var(--text-sub); font-weight: 600; margin-bottom: 10px; letter-spacing: 0.5px; text-transform: uppercase; }
        .history-item { padding: 8px 10px; border-radius: 6px; font-size: 13px; color: var(--text-main); cursor: pointer; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 8px; transition: background 0.2s; }
        .history-item:hover { background: var(--menu-hover); }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; border-bottom: 1px solid transparent; transition: border 0.3s; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .model-selector { padding: 8px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; max-width: 150px; background: var(--bg-main); border-color: var(--border-color); cursor: pointer; }
        
        .viewport { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; scroll-behavior: smooth; }
        .hero-section { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; width: 100%; max-width: 800px; animation: fadeIn 0.5s ease; }
        .shrawan-title { font-size: clamp(28px, 4vw, 42px); font-weight: 700; color: var(--text-main); margin-bottom: 10px; letter-spacing: -1px; }

        /* Action Cards */
        .action-cards-container { display: flex; gap: 15px; margin-top: 30px; width: 100%; justify-content: center; flex-wrap: wrap; }
        .action-card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; display: flex; flex-direction: column; align-items: flex-start; gap: 12px; cursor: pointer; transition: all 0.2s ease; flex: 1 1 180px; max-width: 200px; }
        .action-card:hover { border-color: var(--text-sub); background: var(--menu-hover); }
        .action-card-icon { font-size: 24px; color: var(--text-main); }
        .action-card-text { font-size: 14px; font-weight: 600; color: var(--text-main); }
        .action-card-subtext { font-size: 12px; color: var(--text-sub); }

        /* Chat Flow & Professional Markdown Styles */
        #chat-flow { width: 100%; max-width: 800px; display: none; flex-direction: column; gap: 24px; padding-bottom: 150px; }
        .msg-row { display: flex; gap: 15px; width: 100%; }
        .msg-row.user { justify-content: flex-end; }
        .msg-bubble { padding: 12px 16px; font-size: 15px; line-height: 1.6; max-width: 85%; }
        .msg-row.user .msg-bubble { background: var(--msg-user-bg); color: var(--text-main); border-radius: 12px 12px 2px 12px; }
        .msg-row.bot .msg-bubble { background: transparent; color: var(--text-main); width: 100%; max-width: 100%; }
        
        /* Markdown CSS */
        .msg-bubble p { margin-bottom: 12px; }
        .msg-bubble p:last-child { margin-bottom: 0; }
        .msg-bubble h1, .msg-bubble h2, .msg-bubble h3 { margin: 16px 0 8px 0; font-weight: 600; color: var(--text-main); }
        .msg-bubble ul, .msg-bubble ol { margin-bottom: 12px; padding-left: 20px; }
        .msg-bubble li { margin-bottom: 4px; }
        .msg-bubble pre { background: var(--code-bg); padding: 12px; border-radius: 8px; overflow-x: auto; margin-bottom: 12px; border: 1px solid var(--border-color); }
        .msg-bubble code { font-family: monospace; background: var(--code-bg); padding: 2px 4px; border-radius: 4px; font-size: 13px; color: #ff7b72; }
        .msg-bubble pre code { color: var(--text-main); background: transparent; padding: 0; }
        .msg-bubble table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 14px; }
        .msg-bubble th, .msg-bubble td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; }
        .msg-bubble th { background: var(--menu-hover); font-weight: 600; }

        /* Input Bar */
        .bottom-bar { position: fixed; bottom: 0; width: 100%; padding: 0 20px 20px; background: linear-gradient(to top, var(--bg-main) 80%, transparent); display: flex; flex-direction: column; align-items: center; z-index: 100; pointer-events: none; }
        .input-box-container { width: 100%; max-width: 800px; position: relative; pointer-events: auto; }
        .input-box { background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 12px; display: flex; align-items: flex-end; padding: 8px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: border 0.2s, box-shadow 0.2s; }
        .input-box:focus-within { border-color: var(--accent-color); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        #user-input { flex: 1; background: transparent; border: none; padding: 10px; font-size: 15px; max-height: 150px; overflow-y: auto; resize: none; color: var(--text-main); }
        .input-actions { display: flex; align-items: center; gap: 4px; padding-bottom: 4px; }

        /* --- OS STYLE WINDOW MODALS --- */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .modal-card { background: var(--modal-bg); border-radius: 12px; border: 1px solid var(--border-color); width: 90%; max-width: 550px; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.4); transition: all 0.3s cubic-bezier(0.2, 0, 0, 1); position: relative; overflow: hidden; max-height: 90vh; }
        
        /* Window Controls States */
        .modal-card.maximized { width: 100% !important; max-width: 100% !important; height: 100vh !important; max-height: 100vh !important; border-radius: 0 !important; top: 0; left: 0; }
        .modal-card.minimized { height: 48px !important; overflow: hidden; align-self: flex-end; margin-bottom: 0; border-radius: 12px 12px 0 0; width: 300px; }
        
        /* Mac Style Header */
        .modal-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; background: var(--sidebar-bg); user-select: none; }
        .window-controls { display: flex; gap: 8px; margin-right: 15px; }
        .win-btn { width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .win-btn span { font-size: 10px; opacity: 0; color: #000; transition: 0.2s; }
        .window-controls:hover .win-btn span { opacity: 0.6; }
        .win-close { background: #ff5f56; } .win-min { background: #ffbd2e; } .win-max { background: #27c93f; }
        
        .modal-title { font-size: 13px; font-weight: 600; color: var(--text-main); flex: 1; text-align: center; margin-right: 50px; }
        .modal-body { padding: 24px; overflow-y: auto; flex: 1; background: var(--modal-bg); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-main); }

        /* Pricing Table Clean */
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; padding: 10px 0; }
        .price-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; background: var(--bg-main); display: flex; flex-direction: column; }
        .price-card.premium { border-color: var(--accent-color); box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.1); position: relative; }
        .plan-name { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
        .plan-price { font-size: 28px; font-weight: 700; margin-bottom: 15px; }
        .plan-features { list-style: none; margin-bottom: 20px; flex: 1; }
        .plan-features li { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .plan-btn { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-main); font-weight: 500; font-size: 13px; }
        .price-card.premium .plan-btn { background: var(--accent-color); border: none; color: #fff; }

        /* Profile Menu */
        .profile-menu { position: absolute; top: 60px; right: 20px; background: var(--modal-bg); border: 1px solid var(--border-color); border-radius: 10px; width: 240px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; display: none; z-index: 1100; }
        .profile-header { padding: 16px; border-bottom: 1px solid var(--border-color); background: var(--sidebar-bg); }
        .profile-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .profile-email { color: var(--text-sub); font-size: 12px; }
        .profile-links { list-style: none; padding: 8px 0; }
        .profile-links li { padding: 10px 16px; display: flex; align-items: center; gap: 12px; color: var(--text-main); cursor: pointer; font-size: 13px; }
        .profile-links li:hover { background: var(--menu-hover); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div class="window-controls">
                <button class="win-btn win-close" onclick="closeModal('settings-modal')"><span class="material-icons-outlined">close</span></button>
                <button class="win-btn win-min" onclick="toggleMin('settings-modal')"><span class="material-icons-outlined">remove</span></button>
                <button class="win-btn win-max" onclick="toggleMax('settings-modal')"><span class="material-icons-outlined">open_in_full</span></button>
            </div>
            <div class="modal-title">System Configuration</div>
        </div>
        <div class="modal-body">
            <div class="form-group"><label class="form-label">API Key (Primary)</label><input type="password" id="api-key-1" placeholder="sk-..."></div>
            <div class="form-group"><label class="form-label">Default Model</label><input type="text" id="model-1" value="google/gemini-2.0-flash-lite-preview-02-05:free"></div>
            <button class="primary-btn" style="width: 100%; margin-top: 10px;" onclick="saveSettings()">Save Configuration</button>
        </div>
    </div>
</div>

<div id="tts-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div class="window-controls">
                <button class="win-btn win-close" onclick="closeModal('tts-modal')"><span class="material-icons-outlined">close</span></button>
                <button class="win-btn win-min" onclick="toggleMin('tts-modal')"><span class="material-icons-outlined">remove</span></button>
                <button class="win-btn win-max" onclick="toggleMax('tts-modal')"><span class="material-icons-outlined">open_in_full</span></button>
            </div>
            <div class="modal-title">Voice Studio Pro</div>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Speech Text</label>
                <textarea id="tts-text" rows="4" placeholder="Enter text here..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Voice Model</label>
                <select id="tts-voice">
                    <option value="Shrawan">Shrawan</option>
                    <option value="Rajan">Rajan</option>
                    <option value="Sunisha">Sunisha</option>
                    <option value="Preety">Preety</option>
                </select>
            </div>
            <button class="primary-btn" style="width: 100%;" onclick="generateTTS()"><span class="material-icons-outlined" style="font-size: 18px;">play_arrow</span> Play Audio</button>
        </div>
    </div>
</div>

<div id="image-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div class="window-controls">
                <button class="win-btn win-close" onclick="closeModal('image-modal')"><span class="material-icons-outlined">close</span></button>
                <button class="win-btn win-min" onclick="toggleMin('image-modal')"><span class="material-icons-outlined">remove</span></button>
                <button class="win-btn win-max" onclick="toggleMax('image-modal')"><span class="material-icons-outlined">open_in_full</span></button>
            </div>
            <div class="modal-title">Image Generation Engine</div>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Prompt Describe</label>
                <textarea id="img-prompt" rows="3" placeholder="A cinematic shot of a futuristic city..."></textarea>
            </div>
            <button class="primary-btn" style="width: 100%;" onclick="triggerImageGen()"><span class="material-icons-outlined" style="font-size: 18px;">draw</span> Generate Art</button>
        </div>
    </div>
</div>

<div id="video-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div class="window-controls">
                <button class="win-btn win-close" onclick="closeModal('video-modal')"><span class="material-icons-outlined">close</span></button>
                <button class="win-btn win-min" onclick="toggleMin('video-modal')"><span class="material-icons-outlined">remove</span></button>
                <button class="win-btn win-max" onclick="toggleMax('video-modal')"><span class="material-icons-outlined">open_in_full</span></button>
            </div>
            <div class="modal-title">URL & Video Extractor</div>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Media URL</label>
                <input type="text" id="video-url" placeholder="Paste URL here...">
            </div>
            <button class="primary-btn" style="width: 100%;" onclick="fetchTranscript()">Process Data</button>
        </div>
    </div>
</div>

<div id="pricing-modal" class="modal-overlay">
    <div class="modal-card" style="max-width: 800px;">
        <div class="modal-header">
            <div class="window-controls">
                <button class="win-btn win-close" onclick="closeModal('pricing-modal')"><span class="material-icons-outlined">close</span></button>
                <button class="win-btn win-min" onclick="toggleMin('pricing-modal')"><span class="material-icons-outlined">remove</span></button>
                <button class="win-btn win-max" onclick="toggleMax('pricing-modal')"><span class="material-icons-outlined">open_in_full</span></button>
            </div>
            <div class="modal-title">Upgrade Plan</div>
        </div>
        <div class="modal-body">
             <div class="pricing-grid">
                <div class="price-card">
                    <h3 class="plan-name">Shrawan Base</h3>
                    <div class="plan-price">₹0</div>
                    <ul class="plan-features">
                        <li><span class="material-icons-outlined" style="font-size: 16px;">check</span> Standard Models</li>
                        <li><span class="material-icons-outlined" style="font-size: 16px;">check</span> Normal Speed</li>
                    </ul>
                    <button class="plan-btn">Current</button>
                </div>
                 <div class="price-card premium">
                    <h3 class="plan-name">Shrawan Ultra</h3>
                    <div class="plan-price">₹1,999</div>
                    <ul class="plan-features">
                        <li><span class="material-icons-outlined" style="font-size: 16px; color: var(--accent-color);">check</span> Premium Vision AI</li>
                        <li><span class="material-icons-outlined" style="font-size: 16px; color: var(--accent-color);">check</span> Deep Generation</li>
                        <li><span class="material-icons-outlined" style="font-size: 16px; color: var(--accent-color);">check</span> Maximum Speed</li>
                    </ul>
                    <button class="plan-btn">Upgrade</button>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2 class="brand-title">ShrawanChatAI</h2>
        <button class="icon-btn" onclick="toggleSidebar()"><span class="material-icons-outlined">menu_open</span></button>
    </div>
    <button class="btn-new-chat" onclick="startNewChat()">
        <span class="material-icons-outlined" style="font-size: 18px;">add_circle_outline</span> New Thread
    </button>
    
    <div class="history-section">
        <div class="history-label">Activity</div>
        <div id="history-list"></div>
    </div>
    
    <div style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 15px;">
        <div class="history-item" onclick="setTheme('dark')"><span class="material-icons-outlined" style="font-size: 16px;">dark_mode</span> Dark Theme</div>
        <div class="history-item" onclick="setTheme('light')"><span class="material-icons-outlined" style="font-size: 16px;">light_mode</span> Light Theme</div>
    </div>
</aside>

<main class="main-content">
    <header>
        <button class="icon-btn" onclick="toggleSidebar()"><span class="material-icons-outlined">menu</span></button>
        <div class="header-right">
            <select id="model-select" class="model-selector"></select>
            <div style="position: relative;">
                <img src="https://ui-avatars.com/api/?name=Admin&background=2563eb&color=fff" id="header-avatar" class="icon-btn" style="padding:0; width:32px; height:32px; border-radius:50%;" onclick="toggleProfileMenu()">
                <div class="profile-menu" id="profile-menu">
                    <div class="profile-header">
                        <div class="profile-name">Shrawan User</div>
                        <div class="profile-email">Pro Member</div>
                    </div>
                    <ul class="profile-links">
                        <li onclick="openModal('pricing-modal'); toggleProfileMenu();"><span class="material-icons-outlined">diamond</span> Upgrade to Ultra</li>
                        <li onclick="openModal('settings-modal'); toggleProfileMenu();"><span class="material-icons-outlined">settings</span> System Settings</li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <div class="viewport" id="viewport">
        <div id="hero" class="hero-section">
            <h1 class="shrawan-title">Welcome to the AI Suite</h1>
            
            <div class="action-cards-container">
                <div class="action-card" onclick="openModal('tts-modal')">
                    <span class="material-icons-outlined action-card-icon">mic</span>
                    <span class="action-card-text">Voice Studio</span>
                </div>
                <div class="action-card" onclick="openModal('image-modal')">
                    <span class="material-icons-outlined action-card-icon">image</span>
                    <span class="action-card-text">Image Generator</span>
                </div>
                <div class="action-card" onclick="openModal('video-modal')">
                    <span class="material-icons-outlined action-card-icon">analytics</span>
                    <span class="action-card-text">Data Extractor</span>
                </div>
            </div>
        </div>
        <div id="chat-flow"></div>
    </div>

    <div class="bottom-bar">
        <div class="input-box-container">
            <div class="input-box">
                <button class="icon-btn" onclick="openModal('image-modal')"><span class="material-icons-outlined">add</span></button>
                <textarea id="user-input" rows="1" placeholder="Type your command..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
                <div class="input-actions">
                    <button class="icon-btn" style="background: var(--text-main); color: var(--bg-main);" onclick="sendMessage()"><span class="material-icons-outlined" style="font-size: 18px;">arrow_upward</span></button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Config Marked.js for safe professional markdown parsing
    marked.setOptions({ breaks: true, gfm: true });

    let state = {
        apiKey: localStorage.getItem('shrawan_key1') || "",
        models: [localStorage.getItem('shrawan_model1') || "google/gemini-2.0-flash-lite-preview-02-05:free"],
        theme: localStorage.getItem('shrawan_theme') || 'dark',
        chatHistory: []
    };

    window.onload = () => {
        applyTheme(state.theme);
        document.getElementById('api-key-1').value = state.apiKey;
        document.getElementById('model-select').innerHTML = `<option value="${state.models[0]}">${state.models[0].split('/').pop()}</option>`;
        
        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
    };

    // --- UI CONTROLS ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.getElementById('sidebar-overlay').classList.toggle('active'); }
    function openModal(id) { 
        const m = document.getElementById(id);
        m.classList.add('active'); 
        m.querySelector('.modal-card').classList.remove('minimized', 'maximized');
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function toggleMin(id) {
        const card = document.querySelector(`#${id} .modal-card`);
        card.classList.remove('maximized');
        card.classList.toggle('minimized');
    }
    function toggleMax(id) {
        const card = document.querySelector(`#${id} .modal-card`);
        card.classList.remove('minimized');
        card.classList.toggle('maximized');
    }
    function toggleProfileMenu() {
        const menu = document.getElementById('profile-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    document.addEventListener('click', (e) => { if (!e.target.closest('.header-right')) document.getElementById('profile-menu').style.display = 'none'; });

    function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('shrawan_theme', theme); }
    function setTheme(t) { applyTheme(t); toggleSidebar(); }

    function startNewChat() {
        document.getElementById('chat-flow').innerHTML = '';
        document.getElementById('hero').style.display = 'flex';
        toggleSidebar();
    }
    function scrollToBottom() { const v = document.getElementById('viewport'); v.scrollTo({ top: v.scrollHeight, behavior: 'smooth' }); }

    function saveSettings() {
        state.apiKey = document.getElementById('api-key-1').value.trim();
        localStorage.setItem('shrawan_key1', state.apiKey);
        closeModal('settings-modal');
    }

    // --- TTS LOGIC (Fixed & Professional) ---
    function generateTTS() {
        const text = document.getElementById('tts-text').value.trim();
        const voiceName = document.getElementById('tts-voice').value;
        if(!text) return alert("Text required.");
        
        window.speechSynthesis.cancel();
        let utterance = new SpeechSynthesisUtterance(text);
        
        // Smart Voice Mapping to ensure it sounds natural
        let voices = window.speechSynthesis.getVoices();
        let targetVoice;
        
        if(voiceName === "Shrawan" || voiceName === "Brijesh") {
            targetVoice = voices.find(v => v.lang.includes('hi') && v.name.includes('Male')) || voices.find(v => v.lang.includes('hi'));
        } else if (voiceName === "Sunisha" || voiceName === "Preety") {
            targetVoice = voices.find(v => v.lang.includes('hi') && v.name.includes('Female')) || voices.find(v => v.lang.includes('hi'));
        }
        
        // Fallback to English if Hindi engine missing
        if(!targetVoice) targetVoice = voices.find(v => v.lang.includes('en'));
        
        if(targetVoice) utterance.voice = targetVoice;
        utterance.rate = 0.9; // Professional speaking speed
        window.speechSynthesis.speak(utterance);
    }

    // --- MOCK API ACTIONS (IMAGE & VIDEO) ---
    function triggerImageGen() {
        const prompt = document.getElementById('img-prompt').value.trim();
        if(!prompt) return;
        closeModal('image-modal');
        
        document.getElementById('hero').style.display = 'none';
        const chatFlow = document.getElementById('chat-flow');
        chatFlow.style.display = 'flex';
        
        appendMessage('user', `Generate image: ${prompt}`);
        // Using Pollinations AI for free, instant, direct image rendering without API key
        const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true`;
        
        setTimeout(() => {
            appendMessage('bot', `Here is your generated image:<br><br><img src="${imgUrl}" style="max-width:100%; border-radius:8px; border:1px solid var(--border-color);">`);
        }, 1000);
        document.getElementById('img-prompt').value = '';
    }

    function fetchTranscript() {
        const url = document.getElementById('video-url').value.trim();
        if(!url) return;
        closeModal('video-modal');
        
        document.getElementById('hero').style.display = 'none';
        const chatFlow = document.getElementById('chat-flow');
        chatFlow.style.display = 'flex';
        appendMessage('user', `Extract info from: ${url}`);
        
        setTimeout(() => {
            appendMessage('bot', `**Analysis Complete**\n\nI have scanned the URL context. Since direct video processing requires a backend server, here is the automated structural summary of the link provided:\n\n* **Source:** ${url}\n* **Status:** Processed via frontend mock.\n* **Insight:** To get a full 10,000-word transcript, the system requires backend API integration with YouTube's subtitle endpoints.`);
        }, 1500);
    }

    // --- MAIN CHAT LOGIC ---
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;
        if(!state.apiKey) { openModal('settings-modal'); return; }

        document.getElementById('hero').style.display = 'none';
        const chatFlow = document.getElementById('chat-flow');
        chatFlow.style.display = 'flex';
        
        input.value = ''; input.style.height = 'auto';
        appendMessage('user', text);
        
        const loadingId = 'loading-' + Date.now();
        appendMessage('bot', '<span style="color:var(--text-sub);">Processing...</span>', loadingId);

        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${state.apiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    model: state.models[0], 
                    messages: [
                        {role: "system", content: "You are an advanced AI. Format answers nicely using Markdown."},
                        {role: "user", content: text}
                    ] 
                })
            });
            if(!res.ok) throw new Error("API Connection Failed.");
            const data = await res.json();
            const rawText = data.choices[0].message.content;
            
            // Render professional markdown
            document.getElementById(loadingId).innerHTML = marked.parse(rawText);
        } catch (error) {
            document.getElementById(loadingId).innerHTML = `<span style="color:#ff5f56;">System Error: ${error.message}</span>`;
        }
        scrollToBottom();
    }

    function appendMessage(sender, content, id = null) {
        const chatFlow = document.getElementById('chat-flow');
        const row = document.createElement('div');
        row.className = `msg-row ${sender}`;
        
        // If it's a user message, we just inject text. If bot, we might need markdown later so we inject as raw HTML.
        row.innerHTML = `<div class="msg-bubble" ${id ? `id="${id}"` : ''}>${content}</div>`;
        chatFlow.appendChild(row);
        scrollToBottom();
    }
</script>
</body>
</html>
