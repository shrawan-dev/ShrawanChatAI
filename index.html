<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ShrawanChatAI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1b1e27;--sf:#1e2330;--sf2:#242838;--hv:#29304a;--bd:#2c3650;
  --a:#7cb9f8;--a2:#38bdf8;--a3:#c084fc;
  --t1:#e6eeff;--t2:#8fa3c0;--t3:#4a5e7a;
  --err:#f28b82;--ok:#7dd3a8;--gold:#fcd34d;
  --sw:278px;--th:60px;
  --f:'DM Sans',system-ui,sans-serif;
  --fd:'Outfit',system-ui,sans-serif;
  --tr:.22s cubic-bezier(.4,0,.2,1);
  --r:14px;--rs:9px
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--t1);font-family:var(--f);font-size:15px;-webkit-font-smoothing:antialiased}
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 600px 300px at 10% 0%,rgba(124,185,248,.05),transparent 70%),
             radial-gradient(ellipse 500px 250px at 90% 100%,rgba(192,132,252,.04),transparent 70%)}

/* ‚îÄ‚îÄ SVG S-LOGO ‚îÄ‚îÄ */
.sl{display:flex;align-items:center;justify-content:center;flex-shrink:0;
  background:linear-gradient(145deg,#16305e,#0b1d3d);
  border:1.5px solid rgba(124,185,248,.3);position:relative;overflow:hidden}
.sl::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(124,185,248,.12),transparent)}
.sl svg{z-index:1;position:relative}
.sl-sm{width:34px;height:34px;border-radius:9px}
.sl-md{width:38px;height:38px;border-radius:11px;box-shadow:0 0 16px rgba(124,185,248,.2)}
.sl-lg{width:62px;height:62px;border-radius:18px;box-shadow:0 0 44px rgba(124,185,248,.32)}

/* ‚îÄ‚îÄ MODALS base ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;z-index:3000;background:rgba(5,7,14,.97);
  backdrop-filter:blur(24px);display:flex;align-items:center;justify-content:center;transition:opacity .35s}
.overlay.gone{opacity:0;pointer-events:none}
.modal{background:var(--sf);border:1px solid var(--bd);border-radius:22px;
  padding:44px 40px;width:420px;max-width:93vw;
  box-shadow:0 0 70px rgba(124,185,248,.08),0 30px 60px rgba(0,0,0,.5);
  animation:popIn .48s cubic-bezier(.34,1.56,.64,1)}
@keyframes popIn{from{transform:translateY(44px) scale(.93);opacity:0}to{transform:none;opacity:1}}
.modal h2{font-family:var(--fd);font-size:24px;font-weight:800;margin-bottom:7px}
.modal .sub{color:var(--t2);font-size:13.5px;margin-bottom:26px;line-height:1.6}
.mbrand{display:flex;align-items:center;gap:13px;margin-bottom:28px}
.btxt{font-family:var(--fd);font-weight:800;white-space:nowrap}
.btxt .ca{color:var(--a)}.btxt .cb{color:var(--a2)}

/* form fields */
.fg{margin-bottom:16px}
.fg label{display:block;font-size:11px;font-weight:700;letter-spacing:.09em;color:var(--t2);margin-bottom:6px;text-transform:uppercase}
.fg input,.fg select{width:100%;padding:12px 15px;background:var(--bg);border:1.5px solid var(--bd);
  border-radius:var(--rs);color:var(--t1);font-family:var(--f);font-size:14.5px;outline:none;
  transition:border-color var(--tr),box-shadow var(--tr)}
.fg input:focus,.fg select:focus{border-color:var(--a);box-shadow:0 0 0 3px rgba(124,185,248,.13)}
.fg input::placeholder{color:var(--t3)}
.fg select option{background:var(--sf)}
.fg .hint{font-size:11px;color:var(--t3);margin-top:5px;line-height:1.5}
.fg .hint a{color:var(--a);text-decoration:none}

.btn-p{width:100%;padding:13px;margin-top:6px;
  background:linear-gradient(135deg,#1a66d4,var(--a));
  border:none;border-radius:var(--rs);color:#fff;
  font-family:var(--fd);font-size:15px;font-weight:700;
  cursor:pointer;box-shadow:0 4px 20px rgba(26,102,212,.3);
  transition:transform var(--tr),box-shadow var(--tr)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 7px 28px rgba(26,102,212,.42)}
.btn-p:active{transform:none}
.btn-s{padding:9px 20px;border-radius:20px;
  background:transparent;border:1.5px solid var(--bd);
  color:var(--t2);font-family:var(--f);font-size:13px;font-weight:600;
  cursor:pointer;transition:all var(--tr)}
.btn-s:hover{border-color:var(--a);color:var(--a)}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#app{position:fixed;inset:0;z-index:1;display:flex;opacity:0;transition:opacity .4s}
#app.on{opacity:1}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sb{width:var(--sw);min-width:var(--sw);background:var(--sf);border-right:1px solid var(--bd);
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;z-index:20;
  transition:width var(--tr),min-width var(--tr),opacity var(--tr),border-color var(--tr)}
#sb.off{width:0;min-width:0;opacity:0;border-right-color:transparent}

.sb-top{height:var(--th);padding:0 16px;display:flex;align-items:center;gap:11px;
  border-bottom:1px solid var(--bd);flex-shrink:0;min-width:var(--sw)}

/* Settings button in sidebar */
.sb-set{margin:12px 11px 2px;padding:10px 16px;min-width:calc(var(--sw) - 22px);
  background:rgba(124,185,248,.07);border:1px solid rgba(124,185,248,.2);border-radius:20px;
  color:var(--t2);font-size:13px;font-weight:600;cursor:pointer;
  display:flex;align-items:center;gap:8px;transition:all var(--tr);font-family:var(--f)}
.sb-set:hover{background:rgba(124,185,248,.15);border-color:var(--a);color:var(--a)}

.btn-new{margin:8px 11px 4px;padding:11px 18px;min-width:calc(var(--sw) - 22px);
  background:rgba(124,185,248,.09);border:1.5px solid rgba(124,185,248,.25);border-radius:28px;
  color:var(--a);font-size:13.5px;font-weight:600;cursor:pointer;
  display:flex;align-items:center;gap:9px;transition:all var(--tr);font-family:var(--f);white-space:nowrap}
.btn-new:hover{background:rgba(124,185,248,.18);border-color:var(--a);box-shadow:0 3px 16px rgba(124,185,248,.15)}
.nc-dot{width:26px;height:26px;border-radius:50%;
  background:linear-gradient(135deg,var(--a),var(--a2));
  display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;color:#0d1117;font-weight:800}

.sb-lbl{padding:14px 18px 6px;font-size:10px;font-weight:700;letter-spacing:.12em;
  color:var(--t3);text-transform:uppercase;white-space:nowrap;flex-shrink:0;min-width:var(--sw)}

.clist{flex:1;overflow-y:auto;padding:2px 7px 8px;min-width:var(--sw)}
.clist::-webkit-scrollbar{width:3px}
.clist::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}

.ci{padding:9px 13px;border-radius:28px;cursor:pointer;font-size:13px;color:var(--t2);
  display:flex;align-items:center;gap:8px;transition:all var(--tr);margin-bottom:1px}
.ci:hover{background:var(--hv);color:var(--t1)}
.ci.act{background:rgba(124,185,248,.13);color:var(--a)}
.ci-txt{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.ci-del{opacity:0;background:none;border:none;color:var(--err);cursor:pointer;
  font-size:12px;padding:2px 4px;border-radius:5px;flex-shrink:0;transition:opacity var(--tr)}
.ci:hover .ci-del{opacity:1}
.sb-empty{padding:20px;font-size:12.5px;color:var(--t3);text-align:center;min-width:var(--sw)}

.sb-foot{padding:12px 14px;border-top:1px solid var(--bd);
  display:flex;align-items:center;gap:10px;flex-shrink:0;min-width:var(--sw)}
.sb-av{width:34px;height:34px;border-radius:50%;flex-shrink:0;
  background:linear-gradient(135deg,#1a66d4,var(--a3));
  display:flex;align-items:center;justify-content:center;
  font-family:var(--fd);font-size:15px;font-weight:800;color:#fff}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main{flex:1;display:flex;flex-direction:column;min-width:0;background:var(--bg)}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#tb{height:var(--th);padding:0 18px;border-bottom:1px solid var(--bd);background:var(--sf);
  display:flex;align-items:center;gap:12px;flex-shrink:0;z-index:10}
.ham{width:38px;height:38px;border-radius:50%;background:transparent;border:none;
  color:var(--t2);cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:5px;padding:10px;transition:all var(--tr)}
.ham:hover{background:var(--hv);color:var(--t1)}
.hl{display:block;width:17px;height:2px;background:currentColor;border-radius:2px}
.tb-brand{display:flex;align-items:center;gap:9px;flex:1}
.mdg{font-size:10.5px;font-weight:700;letter-spacing:.07em;
  background:rgba(124,185,248,.1);border:1px solid rgba(124,185,248,.2);
  border-radius:18px;padding:3px 9px;color:var(--a);white-space:nowrap;max-width:140px;
  overflow:hidden;text-overflow:ellipsis}
.tb-acts{display:flex;align-items:center;gap:6px}
.tb-btn{width:36px;height:36px;border-radius:50%;background:transparent;border:none;
  color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--tr)}
.tb-btn:hover{background:var(--hv);color:var(--t1)}
.tb-btn.von{color:var(--ok);animation:pr 1.5s infinite}
@keyframes pr{0%,100%{box-shadow:0 0 0 0 rgba(125,211,168,.4)}50%{box-shadow:0 0 0 7px rgba(125,211,168,0)}}
.prof{width:36px;height:36px;border-radius:50%;
  background:linear-gradient(135deg,#1a66d4,var(--a3));border:2px solid var(--bd);
  color:#fff;font-family:var(--fd);font-size:15px;font-weight:800;
  cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--tr)}
.prof:hover{transform:scale(1.08);border-color:var(--a)}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
#ca{flex:1;overflow-y:auto;padding:24px 0 8px;display:flex;flex-direction:column;scroll-behavior:smooth}
#ca::-webkit-scrollbar{width:4px}
#ca::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}

/* welcome */
#wl{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 20px;text-align:center;animation:fu .5s ease}
@keyframes fu{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:none}}
.wl-logo{margin:0 auto 22px;animation:flt 4s ease-in-out infinite}
@keyframes flt{0%,100%{transform:translateY(0)}50%{transform:translateY(-9px)}}
.wl-title{font-family:var(--fd);font-size:33px;font-weight:800;margin-bottom:10px;letter-spacing:-.4px}
.wl-gr{background:linear-gradient(130deg,var(--a),var(--a2),var(--a3));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.wl-sub{color:var(--t2);font-size:14px;max-width:400px;line-height:1.7;margin-bottom:30px}
.tcards{display:flex;flex-wrap:wrap;gap:9px;justify-content:center;max-width:580px;margin-bottom:22px}
.tc{padding:11px 15px;border-radius:12px;background:var(--sf);border:1px solid var(--bd);
  color:var(--t2);cursor:pointer;display:flex;align-items:center;gap:8px;
  transition:all var(--tr);font-family:var(--f);text-align:left}
.tc:hover{border-color:var(--a);color:var(--t1);background:var(--sf2);transform:translateY(-2px);box-shadow:0 6px 20px rgba(124,185,248,.09)}
.tc-icon{font-size:20px;flex-shrink:0}
.tc-lbl{font-weight:700;font-size:13px;color:var(--t1);margin-bottom:1px}
.tc-desc{font-size:11px;color:var(--t2)}
.chips{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;max-width:520px}
.chip{padding:7px 14px;border-radius:18px;background:var(--sf);border:1px solid var(--bd);
  color:var(--t2);font-size:12.5px;cursor:pointer;transition:all var(--tr);font-family:var(--f)}
.chip:hover{border-color:var(--a);color:var(--a);background:rgba(124,185,248,.07)}

/* messages */
.mw{width:100%;max-width:800px;margin:0 auto;padding:0 20px}
.mr{display:flex;gap:11px;margin-bottom:20px;animation:mi .25s cubic-bezier(.34,1.56,.64,1)}
@keyframes mi{from{opacity:0;transform:translateY(11px) scale(.97)}to{opacity:1;transform:none}}
.mr.u{flex-direction:row-reverse}
.mav{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
.mr.u .mav{background:linear-gradient(135deg,#1a66d4,var(--a3));font-family:var(--fd);font-weight:800;color:#fff;font-size:14px}
.mr.bot .mav{background:linear-gradient(135deg,#162d5a,#0c1d3a);border:1.5px solid rgba(124,185,248,.24)}
.mb{display:flex;flex-direction:column;max-width:660px;min-width:0}
.mr.u .mb{align-items:flex-end}
.bub{padding:13px 17px;border-radius:var(--r);font-size:14.5px;line-height:1.72;word-break:break-word}
.mr.u .bub{background:linear-gradient(135deg,#1c3a60,#142c4c);border:1px solid rgba(124,185,248,.18);border-bottom-right-radius:4px}
.mr.bot .bub{background:var(--sf);border:1px solid var(--bd);border-bottom-left-radius:4px}
.bub.err{border-color:var(--err);background:rgba(242,139,130,.04)}
.tc-ur{display:inline-block;width:2px;height:1.1em;background:var(--a);
  margin-left:2px;vertical-align:text-bottom;animation:bk .7s infinite}
@keyframes bk{0%,100%{opacity:1}50%{opacity:0}}
.bub pre{background:#070c18;border:1px solid var(--bd);border-radius:var(--rs);
  padding:13px;margin:8px 0;overflow-x:auto;font-size:12.5px;font-family:'Courier New',monospace;color:#a5cfff}
.bub code{background:rgba(124,185,248,.1);padding:2px 6px;border-radius:4px;
  font-size:13px;color:#a5cfff;font-family:'Courier New',monospace}
.bub pre code{background:none;padding:0}
.bub strong{color:#fff;font-weight:700}
.bub em{color:var(--a2);font-style:italic}
.ai-img{display:block;max-width:100%;max-height:300px;border-radius:var(--r);
  border:1px solid var(--bd);box-shadow:0 6px 24px rgba(0,0,0,.4);
  transition:opacity .5s,filter .5s;cursor:zoom-in;margin-top:8px;}
.ai-img.ld{opacity:.2;filter:blur(8px)}
.img-cap{font-size:11px;color:var(--t3);margin-top:5px;font-style:italic}
.acts{display:flex;gap:5px;margin-top:7px;opacity:0;transition:opacity var(--tr)}
.mr:hover .acts{opacity:1}
.abt{padding:4px 11px;border-radius:18px;background:var(--sf2);border:1px solid var(--bd);
  color:var(--t3);font-size:11.5px;cursor:pointer;transition:all var(--tr);font-family:var(--f)}
.abt:hover{color:var(--a);border-color:var(--a);background:rgba(124,185,248,.07)}

/* typing */
#ty{display:none;padding:0 20px;max-width:800px;margin:0 auto;width:100%}
#ty.on{display:flex;gap:11px;margin-bottom:18px}
.ty-b{display:flex;align-items:center;gap:5px;background:var(--sf);border:1px solid var(--bd);
  border-radius:var(--r);border-bottom-left-radius:4px;padding:14px 18px}
.td{width:7px;height:7px;border-radius:50%;background:var(--a);animation:dt 1.2s infinite}
.td:nth-child(2){animation-delay:.2s}.td:nth-child(3){animation-delay:.4s}
@keyframes dt{0%,60%,100%{transform:translateY(0);opacity:.3}30%{transform:translateY(-6px);opacity:1}}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
#ia{padding:12px 20px 18px;background:var(--sf);border-top:1px solid var(--bd);flex-shrink:0}
.mode-bar{display:flex;gap:7px;margin-bottom:10px;flex-wrap:wrap}
.mp{padding:5px 13px;border-radius:18px;border:1.5px solid var(--bd);background:transparent;
  color:var(--t2);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--tr);font-family:var(--f)}
.mp:hover{border-color:var(--a);color:var(--a);background:rgba(124,185,248,.07)}
.mp.act{border-color:var(--a);color:var(--a);background:rgba(124,185,248,.1)}
#ip-prev{display:none;align-items:center;gap:9px;padding:9px 13px;background:var(--sf2);
  border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:9px}
#ip-prev.on{display:flex}
#ip-prev img{height:44px;border-radius:7px;object-fit:cover}
#ip-prev span{font-size:12px;color:var(--t2);flex:1}
#ip-prev button{background:none;border:none;color:var(--t3);cursor:pointer;font-size:17px;transition:color var(--tr)}
#ip-prev button:hover{color:var(--err)}
.ibox{background:var(--sf2);border:1.5px solid var(--bd);border-radius:26px;
  padding:9px 11px 9px 16px;display:flex;align-items:flex-end;gap:7px;
  transition:border-color var(--tr),box-shadow var(--tr)}
.ibox:focus-within{border-color:rgba(124,185,248,.48);box-shadow:0 0 0 3px rgba(124,185,248,.09)}
#mi{flex:1;background:transparent;border:none;outline:none;color:var(--t1);
  font-family:var(--f);font-size:15px;resize:none;max-height:150px;min-height:24px;
  line-height:1.5;padding-top:3px;scrollbar-width:none}
#mi::placeholder{color:var(--t3)}
#mi::-webkit-scrollbar{display:none}
.ib{width:34px;height:34px;border-radius:50%;background:transparent;border:none;
  color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--tr);flex-shrink:0}
.ib:hover{background:var(--hv);color:var(--t1)}
.ib.rc{color:var(--err);animation:pr 1s infinite}
#sb-btn{width:40px;height:40px;border-radius:50%;
  background:linear-gradient(135deg,#1a66d4,var(--a));border:none;color:#fff;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all var(--tr);flex-shrink:0;box-shadow:0 3px 14px rgba(26,102,212,.32)}
#sb-btn:hover{transform:scale(1.07);box-shadow:0 5px 20px rgba(26,102,212,.45)}
#sb-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;box-shadow:none}
.ifoot{text-align:center;font-size:11px;color:var(--t3);margin-top:10px}

/* lightbox */
#lb{position:fixed;inset:0;z-index:5000;background:rgba(0,0,0,.94);
  display:none;align-items:center;justify-content:center;cursor:zoom-out}
#lb.on{display:flex}
#lb img{max-width:90vw;max-height:90vh;border-radius:var(--r);box-shadow:0 20px 60px rgba(0,0,0,.8)}
#lb-x{position:absolute;top:16px;right:20px;background:rgba(255,255,255,.1);border:none;
  color:#fff;font-size:21px;cursor:pointer;border-radius:50%;width:38px;height:38px;
  display:flex;align-items:center;justify-content:center;transition:background var(--tr)}
#lb-x:hover{background:rgba(255,255,255,.2)}

/* toast */
#toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(14px);
  background:var(--sf2);border:1px solid var(--bd);border-radius:22px;
  padding:9px 20px;font-size:13px;color:var(--t1);opacity:0;transition:all .28s;
  z-index:9999;box-shadow:0 6px 28px rgba(0,0,0,.5);white-space:nowrap;pointer-events:none}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* api key badge in sidebar */
.api-badge{margin:0 11px 8px;padding:8px 14px;border-radius:var(--rs);
  background:rgba(124,185,248,.06);border:1px solid rgba(124,185,248,.15);
  font-size:11.5px;color:var(--t2);display:flex;align-items:center;gap:6px;cursor:pointer;
  transition:all var(--tr)}
.api-badge:hover{border-color:var(--a);color:var(--a)}
.api-dot{width:7px;height:7px;border-radius:50%;background:var(--err);flex-shrink:0}
.api-dot.set{background:var(--ok)}

@media(max-width:680px){
  :root{--sw:260px}
  #sb{position:absolute;height:100%;box-shadow:4px 0 20px rgba(0,0,0,.5)}
  .wl-title{font-size:26px}
  .mw{padding:0 12px}
  #ia{padding:10px 12px 14px}
}
</style>
</head>
<body>

<div class="overlay gone" id="ov-set">
<div class="modal">
  <div class="mbrand">
    <div class="sl sl-sm">
      <svg width="17" height="17" viewBox="0 0 100 100" fill="none">
        <defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#7cb9f8"/><stop offset="100%" stop-color="#c084fc"/>
        </linearGradient></defs>
        <path d="M68 22C68 22 70 44 50 52C70 60 68 80 68 80" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" fill="none"/>
        <path d="M26 30C26 30 54 30 54 44C54 58 26 58 26 70C26 78 50 78 70 72" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" fill="none"/>
      </svg>
    </div>
    <div class="btxt" style="font-size:17px">‚öôÔ∏è &nbsp;Settings</div>
  </div>
  <h2>API Configuration</h2>
  <p class="sub">Set your OpenRouter API key and choose a model. Your key is saved locally ‚Äî never sent to us.</p>
  <div class="fg">
    <label>OpenRouter API Key</label>
    <input type="password" id="s-key" placeholder="sk-or-v1-...">
    <div class="hint">Get a free key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a></div>
  </div>
  <div class="fg">
    <label>Model</label>
    <select id="s-model">
      <optgroup label="‚úÖ Free Models">
        <option value="openai/gpt-4o-mini">GPT-4o Mini (Recommended ‚Äî Fast &amp; Smart)</option>
        <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Free)</option>
        <option value="google/gemini-flash-1.5">Gemini Flash 1.5</option>
        <option value="meta-llama/llama-3.1-8b-instruct:free">Llama 3.1 8B (Free)</option>
        <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
      </optgroup>
      <optgroup label="‚ö° Paid Models">
        <option value="openai/gpt-4o">GPT-4o</option>
        <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
        <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
      </optgroup>
    </select>
  </div>
  <button class="btn-p" id="s-save">üíæ &nbsp;Save Settings</button>
  <div style="text-align:center;margin-top:12px">
    <button class="btn-s" id="s-close">Cancel</button>
  </div>
</div>
</div>

<div id="lb"><button id="lb-x">‚úï</button><img id="lb-img" src="" alt=""></div>

<div id="app">
  <aside id="sb">
    <div class="sb-top">
      <div class="sl sl-md">
        <svg width="21" height="21" viewBox="0 0 100 100" fill="none">
          <defs><linearGradient id="g2" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#7cb9f8"/><stop offset="100%" stop-color="#c084fc"/>
          </linearGradient></defs>
          <path d="M68 22C68 22 70 44 50 52C70 60 68 80 68 80" stroke="url(#g2)" stroke-width="9.5" stroke-linecap="round" fill="none"/>
          <path d="M26 30C26 30 54 30 54 44C54 58 26 58 26 70C26 78 50 78 70 72" stroke="url(#g2)" stroke-width="9.5" stroke-linecap="round" fill="none"/>
        </svg>
      </div>
      <div class="btxt" style="font-size:15px">Shrawan<span class="ca">Chat</span><span class="cb">AI</span></div>
    </div>

    <button class="sb-set" id="open-set">‚öôÔ∏è &nbsp;Settings &amp; API Key</button>

    <div class="api-badge" id="api-badge">
      <span class="api-dot" id="api-dot"></span>
      <span id="api-status">API Key not set</span>
    </div>

    <button class="btn-new" id="btn-new"><span class="nc-dot">‚úè</span> New Chat</button>

    <div class="sb-lbl">üìã Recent Chats</div>
    <div class="clist" id="clist"><div class="sb-empty" id="sb-empty">No chats yet</div></div>

    <div class="sb-foot">
      <div class="sb-av" id="sb-av">U</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">My Profile</div>
        <div style="font-size:11px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Local User</div>
      </div>
    </div>
  </aside>

  <div id="main">
    <div id="tb">
      <button class="ham" id="ham-btn"><span class="hl"></span><span class="hl"></span><span class="hl"></span></button>
      <div class="tb-brand">
        <div class="sl sl-sm">
          <svg width="16" height="16" viewBox="0 0 100 100" fill="none">
            <defs><linearGradient id="g3" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#7cb9f8"/><stop offset="100%" stop-color="#c084fc"/>
            </linearGradient></defs>
            <path d="M68 22C68 22 70 44 50 52C70 60 68 80 68 80" stroke="url(#g3)" stroke-width="10" stroke-linecap="round" fill="none"/>
            <path d="M26 30C26 30 54 30 54 44C54 58 26 58 26 70C26 78 50 78 70 72" stroke="url(#g3)" stroke-width="10" stroke-linecap="round" fill="none"/>
          </svg>
        </div>
        <span class="btxt" style="font-size:16px">Shrawan<span class="ca">Chat</span><span class="cb">AI</span></span>
        <span class="mdg" id="mdg">GPT-4o Mini</span>
      </div>
      <div class="tb-acts">
        <button class="tb-btn" id="tts-btn" title="Toggle Voice (Auto-read answers)">
          <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          </svg>
        </button>
        <button class="prof" id="prof-btn">U</button>
      </div>
    </div>

    <div id="ca">
      <div id="wl">
        <div class="wl-logo">
          <div class="sl sl-lg" style="width:74px;height:74px;border-radius:22px">
            <svg width="42" height="42" viewBox="0 0 100 100" fill="none">
              <defs><linearGradient id="g4" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#7cb9f8"/><stop offset="48%" stop-color="#38bdf8"/><stop offset="100%" stop-color="#c084fc"/>
              </linearGradient></defs>
              <path d="M68 22C68 22 70 44 50 52C70 60 68 80 68 80" stroke="url(#g4)" stroke-width="8.5" stroke-linecap="round" fill="none"/>
              <path d="M26 30C26 30 54 30 54 44C54 58 26 58 26 70C26 78 50 78 70 72" stroke="url(#g4)" stroke-width="8.5" stroke-linecap="round" fill="none"/>
            </svg>
          </div>
        </div>
        <div class="wl-title">Hello, I'm <span class="wl-gr">ShrawanChatAI</span></div>
        <p class="wl-sub">Superfast AI ‚Äî chat, generate images, read out audio.</p>
        <div class="tcards">
          <div class="tc" onclick="setMode('chat');qp('Explain machine learning simply')">
            <span class="tc-icon">üí¨</span>
            <div><div class="tc-lbl">Smart Chat</div><div class="tc-desc">Ask anything</div></div>
          </div>
          <div class="tc" onclick="setMode('image');qp('aurora borealis over mountains, 8K')">
            <span class="tc-icon">üé®</span>
            <div><div class="tc-lbl">Image Gen</div><div class="tc-desc">Create AI art instantly</div></div>
          </div>
          <div class="tc" onclick="setMode('audio');qp('Hello! I am your AI assistant, ready to help.')">
            <span class="tc-icon">üéß</span>
            <div><div class="tc-lbl">Text-to-Speech</div><div class="tc-desc">Type & listen aloud</div></div>
          </div>
        </div>
      </div>

      <div id="ty">
        <div class="mav" style="background:linear-gradient(135deg,#162d5a,#0c1d3a);border:1.5px solid rgba(124,185,248,.24)">
          <svg width="15" height="15" viewBox="0 0 100 100" fill="none">
            <defs><linearGradient id="gty" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#7cb9f8"/><stop offset="100%" stop-color="#c084fc"/></linearGradient></defs>
            <path d="M68 22C68 22 70 44 50 52C70 60 68 80 68 80" stroke="url(#gty)" stroke-width="11" stroke-linecap="round" fill="none"/>
            <path d="M26 30C26 30 54 30 54 44C54 58 26 58 26 70C26 78 50 78 70 72" stroke="url(#gty)" stroke-width="11" stroke-linecap="round" fill="none"/>
          </svg>
        </div>
        <div class="ty-b"><div class="td"></div><div class="td"></div><div class="td"></div></div>
      </div>
    </div>

    <div id="ia">
      <div class="mode-bar">
        <button class="mp act" data-m="chat" onclick="setMode('chat')">üí¨ Chat</button>
        <button class="mp" data-m="image" onclick="setMode('image')">üé® Image Gen</button>
        <button class="mp" data-m="audio" onclick="setMode('audio')">üéß Text-to-Speech</button>
      </div>
      <div id="ip-prev">
        <img id="ip-img" src="" alt="">
        <span id="ip-name">image.png</span>
        <button onclick="clearImg()">‚úï</button>
      </div>
      <div class="ibox">
        <input type="file" id="img-file" accept="image/*" style="display:none">
        <button class="ib" onclick="document.getElementById('img-file').click()" title="Attach image">
          <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
          </svg>
        </button>
        <textarea id="mi" rows="1" placeholder="Message ShrawanChatAI‚Ä¶"></textarea>
        <button class="ib" id="mic-btn" title="Voice input">
          <svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
            <line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
          </svg>
        </button>
        <button id="sb-btn" title="Send">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <div class="ifoot"><strong>ShrawanChatAI</strong> ¬∑ Configurable API Workspace ‚úÖ</div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ShrawanChatAI ‚Äî Live Stable App
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
const SYS = `You are ShrawanChatAI, a helpful and fast AI assistant. Use Markdown blocks for code.`;

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let convos  = JSON.parse(localStorage.getItem('scai_c') || '[]');
let cfg     = JSON.parse(localStorage.getItem('scai_cfg') || '{"key":"","model":"openai/gpt-4o-mini"}');
let curId   = null, curMode = 'chat';
let busy    = false, ttsOn = false, micOn = false, micObj = null, upImg = null;

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const $  = id => document.getElementById(id);
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const uid = () => 'm' + Date.now() + Math.random().toString(36).slice(2,6);

function toast(m, ms=3000){
  const t=$('toast'); t.textContent=m; t.classList.add('on');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('on'), ms);
}
function autoH(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,150)+'px'; }
function scrollBot(){ $('ca').scrollTo({top:$('ca').scrollHeight,behavior:'smooth'}); }

function md(t){
  return t
    .replace(/```(\w*)\n?([\s\S]*?)```/g,(_,l,c)=>`<pre><code>${esc(c.trim())}</code></pre>`)
    .replace(/`([^`]+)`/g,(_,c)=>`<code>${esc(c)}</code>`)
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^### (.+)$/gm,'<div style="font-weight:700;color:var(--a);margin:9px 0 3px">$1</div>')
    .replace(/^## (.+)$/gm,'<div style="font-size:15px;font-weight:700;margin:10px 0 5px">$1</div>')
    .replace(/^- (.+)$/gm,'<div style="margin:2px 0 2px 13px">‚Ä¢ $1</div>')
    .replace(/\n/g,'<br>');
}

function botSVG(id){
  return `<svg width="15" height="15" viewBox="0 0 100 100" fill="none"><defs><linearGradient id="ga${id}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#7cb9f8"/><stop offset="100%" stop-color="#c084fc"/></linearGradient></defs><path d="M68 22C68 22 70 44 50 52C70 60 68 80 68 80" stroke="url(#ga${id})" stroke-width="11" stroke-linecap="round" fill="none"/><path d="M26 30C26 30 54 30 54 44C54 58 26 58 26 70C26 78 50 78 70 72" stroke="url(#ga${id})" stroke-width="11" stroke-linecap="round" fill="none"/></svg>`;
}

/* ‚îÄ‚îÄ Settings ‚îÄ‚îÄ */
function openSettings(){
  $('s-key').value = cfg.key || '';
  $('s-model').value = cfg.model || 'openai/gpt-4o-mini';
  $('ov-set').classList.remove('gone');
}
function closeSettings(){ $('ov-set').classList.add('gone'); }

function saveSettings(){
  const k = $('s-key').value.trim();
  const m = $('s-model').value;
  if(!k){ toast('‚ö†Ô∏è Please enter your API key'); return; }
  cfg = {key:k, model:m};
  localStorage.setItem('scai_cfg', JSON.stringify(cfg));
  updateApiStatus();
  $('mdg').textContent = m.split('/').pop().slice(0,22);
  closeSettings();
  toast('‚úÖ Settings saved! Ready to chat.');
}

function updateApiStatus(){
  const set = !!(cfg.key && cfg.key.length > 10);
  $('api-dot').className = 'api-dot' + (set?' set':'');
  $('api-status').textContent = set ? '‚úÖ API Key: Active' : '‚ö†Ô∏è API Key not set ‚Äî tap to add';
}

function launch(){
  $('app').classList.add('on');
  $('mdg').textContent = (cfg.model||'gpt-4o-mini').split('/').pop().slice(0,22);
  updateApiStatus();
  renderSB();
  if(!convos.length) newChat(); else loadConvo(convos[0].id);
}

/* ‚îÄ‚îÄ Convos ‚îÄ‚îÄ */
function newChat(){
  const id='c'+Date.now();
  convos.unshift({id, title:'New Chat', messages:[], ts:Date.now()});
  curId=id; save(); renderSB(); clearChat();
  toast('‚ú® New conversation');
}
function loadConvo(id){
  curId=id; clearChat();
  const c=convos.find(v=>v.id===id);
  if(c) c.messages.forEach(m=>{
    renderMsg(m.role, m.rawContent||m.content, m.type||'text', m.mid, false, m.imgData);
  });
  renderSB(); scrollBot();
}
function delConvo(id,e){
  e.stopPropagation();
  convos=convos.filter(c=>c.id!==id); save();
  curId===id?(convos.length?loadConvo(convos[0].id):newChat()):renderSB();
}
function save(){ localStorage.setItem('scai_c', JSON.stringify(convos)); }
function getC(){ return convos.find(c=>c.id===curId); }

function pushMsg(role, content, type, mid, imgData=null){
  const c=getC(); if(!c) return;
  const m = { role, content: typeof content==='string'?content:'[media]', rawContent: content, type: type||'text', mid: mid||uid(), ts: Date.now(), imgData };
  c.messages.push(m);
  if(c.messages.length===2){ const f=c.messages[0].rawContent; c.title=(typeof f==='string'?f:'Chat').slice(0,42); }
  save(); renderSB(); return m.mid;
}

function renderSB(){
  const list=$('clist'), empty=$('sb-empty');
  if(!convos.length){ list.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  list.innerHTML=convos.map(c=>`
    <div class="ci ${c.id===curId?'act':''}" onclick="loadConvo('${c.id}')">
      <span style="font-size:13px;flex-shrink:0">üí¨</span>
      <span class="ci-txt">${esc(c.title)}</span>
      <button class="ci-del" onclick="delConvo('${c.id}',event)">üóë</button>
    </div>`).join('');
}

/* ‚îÄ‚îÄ Render Messages ‚îÄ‚îÄ */
function clearChat(){
  $('ca').querySelectorAll('.mw').forEach(e=>e.remove());
  $('wl').style.display='flex'; $('ty').classList.remove('on');
}

function renderMsg(role, content, type='text', mid, animate=true, imgData=null){
  $('wl').style.display='none';
  const msgId=mid||uid(), ca=$('ca'), ty=$('ty');
  const wrap=document.createElement('div'); wrap.className='mw';
  const row=document.createElement('div'); row.className=`mr ${role}`; row.id='row_'+msgId;
  const av=document.createElement('div'); av.className='mav';
  const body=document.createElement('div'); body.className='mb';
  const bub=document.createElement('div'); bub.className='bub';
  const cdiv=document.createElement('div'); cdiv.id='c_'+msgId;
  
  if(!animate) wrap.style.animation='none';
  if(role==='user'){
    av.textContent='U';
    av.style.cssText='background:linear-gradient(135deg,#1a66d4,var(--a3));font-family:var(--fd);font-weight:800;color:#fff;font-size:14px;';
    body.style.alignItems='flex-end';
  } else {
    av.innerHTML=botSVG(msgId);
    av.style.cssText='background:linear-gradient(135deg,#162d5a,#0c1d3a);border:1.5px solid rgba(124,185,248,.24);';
  }
  
  if(type==='text' || type==='error'){
    let txtHtml = role==='user'?md(esc(content)):md(typeof content==='string'?content:'');
    if(imgData){
      txtHtml += `<br><img src="${imgData}" class="ai-img" style="max-height:180px;cursor:pointer" onclick="openLB('${imgData}')">`;
    }
    cdiv.innerHTML = txtHtml;
    if(type==='error') bub.classList.add('err');
  } else if(type==='image-gen'){
    cdiv.innerHTML='<em style="color:var(--t2)">[Image Generated - Load specific chat to view old generations or recreate]</em>';
  }
  
  bub.appendChild(cdiv);
  if(role!=='user' && type!=='image-gen'){
    const acts=document.createElement('div'); acts.className='acts';
    acts.innerHTML=`<button class="abt" onclick="copyMsg('${msgId}')">üìã Copy</button>
      <button class="abt" onclick="speakMsg('${msgId}')">üîä Speak</button>`;
    bub.appendChild(acts);
  }
  body.appendChild(bub); row.appendChild(av); row.appendChild(body); wrap.appendChild(row);
  ca.insertBefore(wrap, ty); scrollBot();
  return {cdiv, bub, msgId};
}

function sRow(){
  $('wl').style.display='none'; $('ty').classList.remove('on');
  const mid=uid(), ca=$('ca'), ty=$('ty');
  const wrap=document.createElement('div'); wrap.className='mw';
  const row=document.createElement('div'); row.className='mr bot';
  const av=document.createElement('div'); av.className='mav';
  const body=document.createElement('div'); body.className='mb';
  const bub=document.createElement('div'); bub.className='bub';
  const cdiv=document.createElement('div'); cdiv.id='c_'+mid;
  const cur=document.createElement('span'); cur.className='tc-ur';
  av.innerHTML=botSVG(mid+'s'); av.style.cssText='background:linear-gradient(135deg,#162d5a,#0c1d3a);border:1.5px solid rgba(124,185,248,.24);';
  bub.appendChild(cdiv); bub.appendChild(cur);
  body.appendChild(bub); row.appendChild(av); row.appendChild(body); wrap.appendChild(row);
  ca.insertBefore(wrap, ty); scrollBot();
  return {cdiv,cur,bub,mid};
}

function finBot(bub,mid,type='text'){
  bub.querySelectorAll('.tc-ur').forEach(c=>c.remove());
  if(type!=='image-gen'){
    const acts=document.createElement('div'); acts.className='acts';
    acts.innerHTML=`<button class="abt" onclick="copyMsg('${mid}')">üìã Copy</button>
      <button class="abt" onclick="speakMsg('${mid}')">üîä Speak</button>`;
    bub.appendChild(acts);
  }
}

function copyMsg(mid){ const el=document.getElementById('c_'+mid); if(!el)return; navigator.clipboard.writeText(el.innerText||'').then(()=>toast('üìã Copied!')); }
function speakMsg(mid){ const el=document.getElementById('c_'+mid); if(!el)return; speakText(el.innerText||''); }

/* ‚îÄ‚îÄ TTS ‚îÄ‚îÄ */
$('tts-btn').addEventListener('click',()=>{
  if(speechSynthesis.speaking){ speechSynthesis.cancel(); ttsOn=false; updTTS(); toast('üîá Voice stopped'); return; }
  ttsOn=!ttsOn; updTTS(); toast(ttsOn?'üîä Auto-Voice ON':'üîá Auto-Voice OFF');
});
function updTTS(){ $('tts-btn').classList.toggle('von',ttsOn||speechSynthesis.speaking); }
function speakText(text){
  speechSynthesis.cancel();
  const clean=text.replace(/<[^>]+>/g,'').replace(/[*_`#‚Ä¢\-]/g,'').replace(/\s+/g,' ').trim().slice(0,2000);
  if(!clean)return;
  const utt=new SpeechSynthesisUtterance(clean);
  utt.rate=1.1; utt.pitch=1.05; utt.volume=1;
  const vs=speechSynthesis.getVoices();
  const v=vs.find(v=>/david|james|daniel|guy|mark/i.test(v.name))||vs.find(v=>v.lang.startsWith('en'));
  if(v)utt.voice=v;
  utt.onstart=updTTS; utt.onend=utt.onerror=()=>{if(!ttsOn)updTTS();};
  speechSynthesis.speak(utt);
}
speechSynthesis.onvoiceschanged=()=>{};

/* ‚îÄ‚îÄ Image Gen (Pollinations) ‚îÄ‚îÄ */
function isImg(t){ return curMode==='image'||/^(generate image:|image:|draw:|create image:)/i.test(t.trim()); }
function getPrompts(t){ return t.replace(/^(generate image:|image:|draw:|create image:)\s*/i,'').trim().split('|').map(p=>p.trim()).filter(Boolean); }

function renderImages(prompts,cdiv,mid){
  prompts.forEach((p,i)=>{
    const seed=Math.floor(Math.random()*999999);
    const url=`https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=768&height=512&nologo=true&seed=${seed}&model=flux`;
    const wrap=document.createElement('div'); wrap.style.marginTop=i?'14px':'6px';
    const img=document.createElement('img');
    img.className='ai-img ld'; img.crossOrigin='anonymous'; img.referrerPolicy='no-referrer';
    img.alt=p; img.src=url; img.onclick=()=>openLB(url);
    img.onload=()=>{img.classList.remove('ld');scrollBot();};
    img.onerror=()=>{
      img.src=url.replace(/seed=\d+/,'seed='+Math.floor(Math.random()*9999999));
      img.onerror=()=>{ const d=document.createElement('div'); d.style.cssText='color:var(--err);font-size:12.5px;margin-top:5px'; d.textContent='‚ùå Image failed. Try a different prompt.'; wrap.appendChild(d); };
    };
    const cap=document.createElement('div'); cap.className='img-cap'; cap.textContent=`üñº "${p}"`;
    wrap.appendChild(img); wrap.appendChild(cap); cdiv.appendChild(wrap);
  });
}

function openLB(url){ $('lb-img').src=url; $('lb').classList.add('on'); }
$('lb').addEventListener('click',e=>{ if(e.target===$('lb')||e.target===$('lb-x'))$('lb').classList.remove('on'); });

/* ‚îÄ‚îÄ SEND ‚îÄ‚îÄ */
async function send(text){
  text=(text||'').trim();
  if(!text&&!upImg)return;
  if(busy)return;

  // Enforce API key for normal chats
  if(!cfg.key && curMode === 'chat' && !isImg(text)){
    openSettings();
    toast('‚ö†Ô∏è Please add your OpenRouter API key first!',4000);
    return;
  }

  busy=true; $('sb-btn').disabled=true;
  $('mi').value=''; $('mi').style.height='auto';
  
  const imgD=upImg; clearImg();
  const uTxt = text;
  renderMsg('user', uTxt, 'text', null, true, imgD);
  pushMsg('user', uTxt, 'text', null, imgD);

  if(curMode==='audio'){ await hAudio(text); done(); return; }
  if(isImg(text)){ await hImage(text); done(); return; }
  
  await hChat(text); done();
}

function done(){ busy=false; $('sb-btn').disabled=false; $('ty').classList.remove('on'); }

async function hAudio(text){
  $('ty').classList.add('on'); scrollBot();
  const{cdiv,cur,bub,mid}=sRow(); cur.remove();
  
  cdiv.innerHTML=`<div style="font-size:14px;color:var(--t1);"><strong>üîä Playing Text:</strong></div><div style="margin-top:5px;color:var(--t2)">"${esc(text)}"</div>`;
  speakText(text); // Native TTS
  
  finBot(bub,mid,'text'); pushMsg('assistant',text,'text',mid);
}

async function hImage(text){
  const prompts=getPrompts(text);
  $('ty').classList.add('on'); scrollBot();
  const{cdiv,cur,bub,mid}=sRow(); cur.remove();
  cdiv.innerHTML=`<div style="color:var(--t2);margin-bottom:6px">üé® Generating <strong>${prompts.length}</strong> image${prompts.length>1?'s':''}‚Ä¶</div>`;
  renderImages(prompts,cdiv,mid); finBot(bub,mid,'image-gen'); pushMsg('assistant',prompts.join(' | '),'image-gen',mid);
}

async function hChat(text){
  $('ty').classList.add('on'); scrollBot();
  const c=getC();
  
  // Format history for multimodal capability
  const hist=(c?.messages||[]).slice(-20).map(m=>{
    let content = m.rawContent || '';
    if(m.imgData && m.role === 'user') {
      content = [
        {type: "text", text: content},
        {type: "image_url", image_url: {"url": m.imgData}}
      ];
    }
    return {
      role: m.role==='user'?'user':'assistant',
      content: content
    };
  });
  
  $('ty').classList.remove('on');
  const{cdiv,cur,bub,mid}=sRow();
  let full='';
  try{
    const res=await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${cfg.key}`,'HTTP-Referer':location.href,'X-Title':'ShrawanChatAI'},
      body:JSON.stringify({model:cfg.model,stream:true,max_tokens:1500,messages:[{role:'system',content:SYS},...hist]})
    });
    if(!res.ok){
      const errText=await res.text();
      if(res.status===401||res.status===403) throw new Error(`Invalid API key. Please check your key in Settings. (${res.status})`);
      if(res.status===429) throw new Error('Rate limit reached. Wait a moment or upgrade your plan.');
      throw new Error(`API error ${res.status}: ${errText.slice(0,100)}`);
    }
    const reader=res.body.getReader(), dec=new TextDecoder();
    while(true){
      const{done,value}=await reader.read(); if(done)break;
      const chunk=dec.decode(value,{stream:true});
      for(const line of chunk.split('\n')){
        if(!line.startsWith('data:'))continue;
        const data=line.slice(5).trim(); if(data==='[DONE]')break;
        try{const j=JSON.parse(data);const d=j.choices?.[0]?.delta?.content||'';if(d){full+=d;cdiv.innerHTML=md(full);scrollBot();}}catch{}
      }
    }
    cur.remove(); finBot(bub,mid,'text');
    if(ttsOn)speakText(full);
    pushMsg('assistant',full,'text',mid);
  }catch(e){
    cur.remove();
    cdiv.innerHTML=`<div style="color:var(--err)">‚ö†Ô∏è <strong>${esc(e.message)}</strong>
      <br><br><small style="color:var(--t2)">Go to <strong>Settings</strong> (sidebar) to fix your API key.</small></div>`;
    bub.classList.add('err');
  }
}

/* ‚îÄ‚îÄ Mode ‚îÄ‚îÄ */
function setMode(m){
  curMode=m;
  document.querySelectorAll('.mp').forEach(p=>p.classList.toggle('act',p.dataset.m===m));
  const ph={chat:'Message ShrawanChatAI‚Ä¶',image:'Describe image‚Ä¶ Use | for multiple',audio:'Enter text to hear aloud‚Ä¶'};
  $('mi').placeholder=ph[m]||ph.chat;
}

/* ‚îÄ‚îÄ Input handlers ‚îÄ‚îÄ */
const mi=$('mi');
mi.addEventListener('input',()=>autoH(mi));
mi.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send(mi.value);} });
$('sb-btn').addEventListener('click',()=>send(mi.value));
function qp(t){ mi.value=t; autoH(mi); mi.focus(); }

$('img-file').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{ upImg=ev.target.result; $('ip-img').src=upImg; $('ip-name').textContent=f.name; $('ip-prev').classList.add('on'); toast('üñº Image attached!'); };
  r.readAsDataURL(f);
});
function clearImg(){ upImg=null; $('ip-prev').classList.remove('on'); $('img-file').value=''; }

$('mic-btn').addEventListener('click',()=>{
  if(micOn){if(micObj)micObj.stop();micOn=false;$('mic-btn').classList.remove('rc');return;}
  const R=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!R){toast('‚ö†Ô∏è Voice input needs Chrome');return;}
  micObj=new R(); micObj.lang='hi-IN'; micObj.continuous=false; micObj.interimResults=false;
  micObj.onstart=()=>{micOn=true;$('mic-btn').classList.add('rc');toast('üé§ Listening‚Ä¶');};
  micObj.onresult=e=>{const t=e.results[0][0].transcript;mi.value=t;autoH(mi);send(t);};
  micObj.onerror=micObj.onend=()=>{micOn=false;$('mic-btn').classList.remove('rc');};
  micObj.start();
});

$('ham-btn').addEventListener('click',()=>$('sb').classList.toggle('off'));
$('btn-new').addEventListener('click',newChat);
$('open-set').addEventListener('click',openSettings);
$('api-badge').addEventListener('click',openSettings);
$('s-save').addEventListener('click',saveSettings);
$('s-close').addEventListener('click',closeSettings);
$('prof-btn').addEventListener('click',()=>openSettings());

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
launch();
</script>
</body>
</html>
