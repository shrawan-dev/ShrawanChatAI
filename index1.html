const CONFIG = {
    apiKey: "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",
    primaryModel: "google/gemma-3-27b-it:free",
    backupModel: "google/gemini-2.0-flash-lite:free" // Agar Gemma busy ho toh ye chalega
};

async function startChat() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text) return;

    document.getElementById('welcome-ui').style.display = 'none';
    const chatFlow = document.getElementById('chat-flow');
    chatFlow.style.display = 'flex';
    chatFlow.innerHTML += `<div class="msg user-msg">${text}</div>`;
    input.value = '';

    const botDiv = document.createElement('div');
    botDiv.className = 'msg bot-msg';
    botDiv.innerHTML = `<b>RealChat</b><br><span class="typing" id="status-text">Thinking...</span>`;
    chatFlow.appendChild(botDiv);
    chatFlow.scrollTop = chatFlow.scrollHeight;

    // API Call with Fallback Logic
    try {
        let response = await callOpenRouter(CONFIG.primaryModel, text);
        
        // Agar pehla model busy ho (Error 429 ya 503)
        if (!response.ok) {
            document.getElementById('status-text').innerText = "Switching to Backup Model...";
            response = await callOpenRouter(CONFIG.backupModel, text);
        }

        const data = await response.json();
        
        if (data.choices && data.choices[0]) {
            const reply = data.choices[0].message.content;
            botDiv.innerHTML = `<b>RealChat</b><br>${reply}`;
            speak(reply);
        } else {
            botDiv.innerHTML = "<b>System:</b> Sabhi models busy hain. Kripya thodi der baad koshish karein.";
        }
    } catch (err) {
        botDiv.innerHTML = "<b>Error:</b> Internet issue ya API connection fail.";
    }
    chatFlow.scrollTop = chatFlow.scrollHeight;
}

async function callOpenRouter(modelId, message) {
    return await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${CONFIG.apiKey}`,
            "HTTP-Referer": window.location.href,
            "X-Title": "RealChat AI",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            "model": modelId,
            "messages": [{"role": "user", "content": message}],
            "route": "fallback" // OpenRouter ko alternate server use karne ko bolta hai
        })
    });
}

